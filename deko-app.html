<link rel="import" href="../deko-app/da-elements.html">
<link rel="import" href="../app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../polymerfire/polymerfire.html">

<dom-module id="deko-app">

    <template>
    <style include="deko-app-shared-styles"></style>

    <da-toolbar
        signed-in="[[signedIn]]"
        on-sign-out="signOut">
    </da-toolbar>

    <da-login
        on-sign-in="signIn"
        signed-in="[[signedIn]]"
        disabled="[[!online]]">
    </da-login>

    <firebase-auth
        id="auth"
        app-name="decks"
        provider="google"
        signed-in="{{signedIn}}"
        user="{{user}}">
    </firebase-auth>

    <firebase-query
        id="query"
        app-name="decks"
        path="/decks/[[user.uid]]"
        data="{{data}}">
    </firebase-query>

    <app-indexeddb-mirror
        session="[[user.uid]]"
        key="decks"
        data="{{data}}"
        persisted-data="{{persistedData}}">
    </app-indexeddb-mirror>

    <div class="decks">
      <template is="dom-repeat" items="[[persistedData]]" as="deck">
        <da-deck id$="[[deck.$key]]" title="[[deck.title]]" body="[[deck.body]]" on-tap="edit">
        </da-deck>
      </template>
    </div>

    <paper-fab icon="add" disabled="[[!online]]" on-tap="create"></paper-fab>

    <firebase-document id="document" app-name="decks" path="[[editableNoteId]]" data="{{editableNote}}">
    </firebase-document>

    <da-editor id="editor" deck="{{editableNote}}" on-close="commitChange">
    </da-editor>

    </template>
</dom-module>
<script>
  (() => {
    'use strict';
      Polymer({
        is: 'deko-app',
          behaviors: [
          Polymer.NoteAppBehavior
        ],
        get isEditable() {
          return this.online;
        },
        get decksPath() {
          return `/decks/${this.user.uid}`;
        },
        toEditableId(deckId) {
          return `${this.decksPath}/${deckId}`;
        },
        signIn() {
          this.$.auth.signInWithPopup();
        }
      });
    })();
  </script>
